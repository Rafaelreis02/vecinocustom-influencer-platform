// VecinoCustom Influencer Platform - Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS & AUTH
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String?   // Hashed
  role          UserRole  @default(ADMIN)
  emailSignature String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  createdInfluencers  Influencer[]  @relation("CreatedBy")
  createdCampaigns    Campaign[]    @relation("CreatedBy")
  
  @@map("users")
}

enum UserRole {
  ADMIN           // Acesso total
  ASSISTANT       // Humano Ajudante - operacional limitado
  AI_AGENT        // Intelig√™ncia Artificial - acesso via API
}

// ============================================
// INFLUENCERS
// ============================================

model Influencer {
  id                String              @id @default(cuid())
  name              String
  email             String?
  phone             String?
  
  // Social Media
  instagramHandle   String?
  instagramFollowers Int?
  tiktokHandle      String?
  tiktokFollowers   Int?
  youtubeHandle     String?
  youtubeFollowers  Int?
  avatarUrl         String?             // Foto de perfil do influencer
  
  // Metrics & Performance
  totalLikes        BigInt?             // Total de likes
  engagementRate    Float?              // Taxa de engagement (%)
  averageViews      String?             // Ex: "3K-30K"
  contentStability  String?             // HIGH, MEDIUM, LOW
  
  // Demographics & Content
  country           String?             // Pa√≠s
  language          String?             // Idioma (PT, ES, EN, etc.)
  niche             String?             // Fashion, Lifestyle, etc.
  contentTypes      String[]            // ["Hauls", "Unboxings", "Lifestyle"]
  primaryPlatform   String?             // TikTok, Instagram, YouTube
  biography         String?             // Bio do perfil
  verified          Boolean?            @default(false) // Perfil verificado
  videoCount        Int?                // N√∫mero total de v√≠deos
  
  // Business
  nif               String?             // Tax ID
  address           String?
  bankDetails       String?             // JSON or encrypted
  estimatedPrice    Float?              // Pre√ßo estimado por v√≠deo
  fitScore          Int?                // 1-5 score para joias
  
  // Portal Fields
  portalToken        String?   @unique @default(uuid())
  ddiCode            String?   // Phone country code (+351, +34, etc.)
  agreedPrice        Float?    // The actual price proposed/negotiated (NOT estimatedPrice which is AI estimate)
  productSuggestion1 String?   // URL of product suggestion 1 from influencer
  productSuggestion2 String?   // URL of product suggestion 2 from influencer
  productSuggestion3 String?   // URL of product suggestion 3 from influencer
  chosenProduct      String?   // URL of product chosen by admin
  trackingUrl        String?   // Shipping tracking URL
  shippingAddress    String?   // Full shipping address
  
  // Status
  status            InfluencerStatus    @default(UNKNOWN)
  tier              String?             // Micro, Macro, Mega, etc.
  notes             String?
  tags              String[]            // Array of tags
  
  // AI Analysis
  analysisSummary   String?   @db.Text  // Resumo da an√°lise do Sonnet
  analysisDate      DateTime?           // Quando foi analisado pela √∫ltima vez
  
  // Discovery
  discoveryMethod   String?             // Como foi encontrado (MANUAL, AUTOMATED)
  discoveryDate     DateTime?           // Quando foi descoberto
  
  // Metadata
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  createdById       String
  createdBy         User                @relation("CreatedBy", fields: [createdById], references: [id])
  
  // Relations
  campaigns         CampaignInfluencer[]
  videos            Video[]
  coupons           Coupon[]
  payments          Payment[]
  paymentBatches    PaymentBatch[]    // Pagamentos agregados efetuados
  files             File[]
  emails            Email[]           @relation("InfluencerEmails")
  
  @@map("influencers")
}

enum InfluencerStatus {
  // Fase 1: Prospe√ß√£o
  UNKNOWN            // üîç Desconhecido - n√£o tem rede social associada
  SUGGESTION         // üí° Sugest√£o - IA sugeriu via scraping
  IMPORT_PENDING     // ‚è≥ A Importar - a ser analisado pelo agente

  // Fase 2: A Negociar
  ANALYZING          // üîé Em An√°lise - estamos a analisar proposta do influencer
  COUNTER_PROPOSAL   // ‚Ü©Ô∏è Contraproposta - influencer a analisar a nossa proposta

  // Fase 3: Em Curso
  AGREED             // ü§ù Acordado - valores acordados, falta sugerir produtos + morada
  PRODUCT_SELECTION  // üéÅ Sele√ß√£o Produto - produto escolhido, aguardar confirma√ß√£o design
  CONTRACT_PENDING   // üìù Contrato Pendente - design escolhido, falta assinar contrato
  SHIPPED            // üì¶ Enviado - encomenda enviada, falta entregar conte√∫do
  COMPLETED          // ‚úÖ Conclu√≠do - conte√∫do entregue e aprovado

  // Especiais
  CANCELLED          // ‚ùå Cancelado
  BLACKLISTED        // üö´ Bloqueado
}

// ============================================
// CAMPAIGNS
// ============================================

model Campaign {
  id                String              @id @default(cuid())
  name              String
  description       String?
  hashtag           String?             // Hashtag de tracking (#vecinodiadosnamorados)
  platform          Platform?           // Plataforma principal (TikTok, Instagram, etc.)
  
  // Dates
  startDate         DateTime?
  endDate           DateTime?
  
  // Budget & Goals
  budget            Float?
  targetViews       Int?
  targetSales       Int?
  
  // Status
  status            CampaignStatus      @default(DRAFT)
  
  // Metadata
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  createdById       String
  createdBy         User                @relation("CreatedBy", fields: [createdById], references: [id])
  
  // Relations
  influencers       CampaignInfluencer[]
  videos            Video[]
  files             File[]
  snapshots         CampaignVideoSnapshot[]
  
  @@map("campaigns")
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

// ============================================
// CAMPAIGN <> INFLUENCER (Many-to-Many)
// ============================================

model CampaignInfluencer {
  id              String      @id @default(cuid())
  
  campaignId      String
  campaign        Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  influencerId    String
  influencer      Influencer  @relation(fields: [influencerId], references: [id], onDelete: Cascade)
  
  // Terms
  agreedFee       Float?
  commissionRate  Float?      // Percentage
  deliverables    String?     // Expected posts/videos
  
  // Status
  status          String      @default("pending") // pending, confirmed, completed
  
  // Metadata
  joinedAt        DateTime    @default(now())
  
  @@unique([campaignId, influencerId])
  @@map("campaign_influencers")
}

// ============================================
// VIDEOS / POSTS
// ============================================

model Video {
  id              String      @id @default(cuid())
  
  // Basic Info
  title           String?
  description     String?
  url             String      // TikTok/Instagram link
  platform        Platform
  
  // Relations
  campaignId      String?
  campaign        Campaign?   @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  
  // ALTERADO: influencerId agora √© OPCIONAL
  influencerId    String?
  influencer      Influencer?  @relation(fields: [influencerId], references: [id], onDelete: SetNull)
  
  // NOVOS CAMPOS - para identificar o autor mesmo sem influencer registado
  authorHandle      String?     // @handle do TikTok/Instagram do autor
  authorDisplayName String?     // Nome de display do autor
  
  // Metrics
  views           Int?
  likes           Int?
  comments        Int?
  shares          Int?
  saves           Int?
  
  // Financials
  cost            Float?      // Custo/Pre√ßo pago por este v√≠deo espec√≠fico
  
  // Dates
  publishedAt     DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Nova rela√ß√£o
  snapshots       CampaignVideoSnapshot[]
  
  @@map("videos")
}

enum Platform {
  TIKTOK
  INSTAGRAM
  YOUTUBE
  OTHER
}

// ============================================
// COUPONS / DISCOUNT CODES
// ============================================

model Coupon {
  id              String      @id @default(cuid())
  code            String      @unique
  
  // Relations
  influencerId    String
  influencer      Influencer  @relation(fields: [influencerId], references: [id], onDelete: Cascade)
  
  // Discount
  discountType    DiscountType @default(PERCENTAGE)
  discountValue   Float       // 10 for 10% or 10 for 10‚Ç¨
  
  // Usage
  usageCount      Int         @default(0)
  usageLimit      Int?        // Max uses (null = unlimited)
  
  // Tracking (manual for now, Shopify later)
  totalSales      Float       @default(0)
  totalOrders     Int         @default(0)
  
  // Commission
  commissionRate    Float?          // Percentagem de comiss√£o do influencer
  
  // Dates
  validFrom       DateTime?
  validUntil      DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Shopify Integration
  shopifyId             String?     @unique
  shopifyPriceRuleId    String?     // ID da price rule no Shopify
  shopifyDiscountCodeId String?     // ID do discount code no Shopify
  
  @@map("coupons")
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
}

// ============================================
// PAYMENTS
// ============================================

model Payment {
  id              String        @id @default(cuid())
  
  influencerId    String
  influencer      Influencer    @relation(fields: [influencerId], references: [id], onDelete: Cascade)
  
  // Amount
  amount          Float
  currency        String        @default("EUR")
  
  // Details
  description     String?
  invoiceNumber   String?
  
  // Status
  status          PaymentStatus @default(PENDING)
  paidAt          DateTime?
  
  // Reference (optional)
  reference       String?       // Transaction ID, etc.
  
  // Metadata
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@map("payments")
}

enum PaymentStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
  CANCELLED
}

// ============================================
// PAYMENT BATCHES (Pagamentos agregados)
// ============================================

model PaymentBatch {
  id              String        @id @default(cuid())
  
  influencerId    String
  influencer      Influencer    @relation(fields: [influencerId], references: [id], onDelete: Cascade)
  
  // Total pago neste lote
  totalAmount     Float
  currency        String        @default("EUR")
  
  // Data do pagamento
  paidAt          DateTime      @default(now())
  
  // Refer√™ncia (opcional: n¬∫ transfer√™ncia, etc.)
  reference       String?
  
  // IDs das comiss√µes pagas neste lote (JSON array)
  commissionIds   String
  
  // Metadata
  createdAt       DateTime      @default(now())
  
  @@map("payment_batches")
}

// ============================================
// FILES / MEDIA
// ============================================

model File {
  id              String      @id @default(cuid())
  
  // File Info
  filename        String
  originalName    String
  mimeType        String
  size            Int         // bytes
  url             String      // S3/R2 URL
  
  // Type
  type            FileType    @default(OTHER)
  
  // Relations (optional - can belong to multiple entities)
  influencerId    String?
  influencer      Influencer? @relation(fields: [influencerId], references: [id], onDelete: Cascade)
  
  campaignId      String?
  campaign        Campaign?   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  // Metadata
  uploadedAt      DateTime    @default(now())
  
  @@map("files")
}

enum FileType {
  CONTRACT
  INVOICE
  MEDIA
  AVATAR
  OTHER
}

// ============================================
// EMAILS / INBOX (CRM)
// ============================================

model Email {
  id              String        @id @default(cuid())
  
  // Email Info
  from            String        // Remetente (email)
  to              String        // Destinat√°rio (email)
  subject         String
  body            String        @db.Text
  htmlBody        String?       @db.Text
  
  // Gmail Integration
  gmailId         String?       @unique
  gmailThreadId   String?
  
  // Relations
  influencerId    String?
  influencer      Influencer?   @relation("InfluencerEmails", fields: [influencerId], references: [id], onDelete: SetNull)
  
  // Attachments
  attachments     Json?         // JSON array of {filename, mimeType, size, attachmentId}
  
  // Metadata
  receivedAt      DateTime
  isRead          Boolean       @default(false)
  isFlagged       Boolean       @default(false)
  labels          String[]      // Gmail labels
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@map("emails")
  @@index([influencerId])
  @@index([gmailThreadId])
  @@index([from])
}

// ============================================
// CAMPAIGN VIDEO SNAPSHOTS - Hist√≥rico di√°rio
// ============================================

model CampaignVideoSnapshot {
  id              String      @id @default(cuid())
  
  videoId         String
  video           Video       @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  campaignId      String
  campaign        Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  // M√©tricas do snapshot
  views           Int         @default(0)
  likes           Int         @default(0)
  comments        Int         @default(0)
  shares          Int         @default(0)
  
  snapshotDate    DateTime    @db.Date
  
  createdAt       DateTime    @default(now())
  
  @@unique([videoId, snapshotDate])
  @@index([campaignId, snapshotDate])
  @@index([videoId])
  @@map("campaign_video_snapshots")
}

// ============================================
// SHOPIFY INTEGRATION
// ============================================

model ShopifyAuth {
  id            String   @id @default(cuid())
  shop          String   @unique
  accessToken   String
  scope         String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("shopify_auth")
}

// ============================================
// WEBHOOK MANAGEMENT
// ============================================

model WebhookConfig {
  id            String   @id @default(cuid())
  platform      String   // SHOPIFY, GMAIL, etc
  email         String   // Email do admin para rastreamento
  webhookUrl    String
  isActive      Boolean  @default(true)
  config        String?  @db.Text // JSON config (opcional)
  registeredAt  DateTime @default(now())
  lastUpdated   DateTime @updatedAt
  
  // √çndices para busca r√°pida
  @@unique([platform, email])
  @@index([email])
  @@index([platform])
  @@map("webhook_configs")
}

model WebhookMigrationLog {
  id             String   @id @default(cuid())
  oldEmail       String
  newEmail       String
  count          Int      // Quantos webhooks foram migrados
  status         String   // SUCCESS, FAILED, PARTIAL
  errorMessage   String?  @db.Text
  migratedAt     DateTime @default(now())
  
  @@index([oldEmail])
  @@index([newEmail])
  @@index([status])
  @@map("webhook_migration_logs")
}

